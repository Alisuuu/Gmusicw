<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Player Invidious Playlist</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.polyfill.io/v3/polyfill.min.js?features=default,fetch,Promise"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #000;
        }

        #player-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }

        #background-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            z-index: 1;
        }

        @supports not ((-webkit-backdrop-filter: none) or (backdrop-filter: none)) {
          #background-overlay {
            background: rgba(0, 0, 0, 0.7);
          }
        }

        #visualizer-container {
            position: absolute;
            inset: 0;
            z-index: 6; /* On top of everything, but still allows interaction */
            pointer-events: none;
            display: flex;
            justify-content: space-around; /* Distribute elements horizontally */
            align-items: flex-end; /* Start from the bottom */
            overflow: hidden;
        }

        .visualizer-element {
            width: 20px;
            height: 20px;
            transform-origin: bottom;
            opacity: 0;
            /* box-shadow will be set by JS for random colors */
        }

        .visualizer-element.jumping {
            animation: jump 0.5s infinite alternate; /* Adjust duration and timing as needed */
        }

        @keyframes jump {
            from { opacity: 0.3; transform: scaleY(1); } /* Changed from 0.7 to 0.3 */
            to { opacity: 0.6; transform: scaleY(5); } /* Changed from 1 to 0.6 */
        }

        #audio-player-element {
            display: none; /* Hidden, controlled by JS */
        }

        #playlist-sidebar {
            width: 25%;
            height: 100%;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.6);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            padding: 1rem;
            padding-bottom: 8rem;
            z-index: 3;
        }

        @supports not ((-webkit-backdrop-filter: none) or (backdrop-filter: none)) {
          #playlist-sidebar {
            background-color: rgba(0, 0, 0, 0.8);
          }
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem;
            margin-bottom: 0.6rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .playlist-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .playlist-thumb {
            width: 70px;
            height: 45px;
            border-radius: 0.25rem;
            object-fit: cover;
            flex-shrink: 0;
        }

        .playlist-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            font-size: 0.9rem;
            overflow: hidden;
        }

        .playlist-title {
            font-weight: 600;
            color: #fff;
            word-break: break-word;
            line-height: 1.2rem;
        }

        .playlist-channel {
            color: #ddd;
            font-size: 0.8rem;
            line-height: 1rem;
        }

        #controls {
            position: fixed;
            bottom: 2.5rem;
            left: 50%;
            width: 90%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 5;
            transition: background-image 0.5s ease-in-out;
        }

        @supports not ((-webkit-backdrop-filter: none) or (backdrop-filter: none)) {
          #controls {
            background-color: rgba(0, 0, 0, 0.8);
          }
        }

        .control-button {
            padding: 0.7rem;
            border-radius: 9999px;
            background-color: rgba(0, 0, 0, 0.5);
            transition: transform 0.3s;
        }

        .control-button:hover {
            transform: scale(1.1);
        }

        #initial-play-button.fade-out {
            animation: fadeOut 0.5s forwards;
        }

        #controls.fade-in {
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            #player-container {
                flex-direction: column;
            }

            #audio-player-element {
                width: 100%;
                height: 50%;
            }

            #playlist-sidebar {
                width: 100%;
                height: 100%;
                display: block;
                padding: 0.5rem 0.5rem 8rem;
                border-top-left-radius: 1.5rem;
                border-top-right-radius: 1.5rem;
            }

            .playlist-thumb {
                width: 80px;
                height: 50px;
            }

            .playlist-info {
                font-size: 1rem;
            }

            .playlist-title {
                font-size: 0.95rem;
            }

            .playlist-channel {
                font-size: 0.8rem;
            }

            #controls {
                flex-direction: column;
                gap: 0.5rem;
                padding: 1rem;
            }

            #controls .song-info {
                display: none;
            }

            #controls .player-controls {
                width: 100%;
            }
        }

        /* Custom styles for the volume slider */
        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
            margin-top: -7px; /* Adjust to center the thumb vertically */
        }

        .custom-range::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        .custom-range::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            background: #4a5568; /* Tailwind gray-700 */
            border-radius: 5px;
        }

        .custom-range::-moz-range-track {
            width: 100%;
            height: 2px;
            background: #4a5568; /* Tailwind gray-700 */
            border-radius: 5px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="player-container">
        <div id="background-overlay"></div>
        <audio id="audio-player-element" controls></audio>

        <div id="playlist-sidebar">
            <h2 class="text-xl font-bold text-white mb-4">Playlist</h2>
            <div id="playlistContainer" class="p-4"></div>
        </div>

        <!-- Visualizer Container -->
        <div id="visualizer-container">
            <div class="visualizer-element"></div>
            <div class="visualizer-element"></div>
            <div class="visualizer-element"></div>
            <div class="visualizer-element"></div>
            <div class="visualizer-element"></div>
            <div class="visualizer-element"></div>
            <div class="visualizer-element"></div>
            <div class="visualizer-element"></div>
            <div class="visualizer-element"></div>
            <div class="visualizer-element"></div>
        </div>

        <div id="initial-play-button" class="absolute inset-0 flex items-center justify-center z-10">
            <button class="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-md">
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16">
                    <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                </svg>
            </button>
        </div>
    </div>

    <div id="controls" class="items-center hidden">
        <div class="song-info flex items-center gap-4 w-1/4">
            <img id="current-song-image" src="" class="w-12 h-12 rounded-md">
            <div>
                <p id="current-song-title" class="font-bold text-white truncate">Song Title</p>
                <p id="current-song-artist" class="text-gray-400 truncate">Artist</p>
            </div>
        </div>

        <div class="player-controls flex flex-col items-center gap-2 w-1/2">
            <div class="flex items-center gap-2">
                <button id="prev-btn" class="control-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-skip-start-fill" viewBox="0 0 16 16">
                      <path d="M4 4a.5.5 0 0 1 1 0v3.248l6.267-3.636c.54-.313 1.232.066 1.232.696v7.384c0 .63-.692 1.01-1.232.697L5 8.753V12a.5.5 0 0 1-1 0V4z"/>
                    </svg>
                </button>
                <button id="play-pause-btn" class="control-button p-2">
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16">
                      <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                    </svg>
                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-pause-fill hidden" viewBox="0 0 16 16">
                      <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
                    </svg>
                </button>
                <button id="next-btn" class="control-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-skip-end-fill" viewBox="0 0 16 16">
                      <path d="M12.5 4a.5.5 0 0 0-1 0v3.248L5.233 3.612C4.693 3.3 4 3.678 4 4.308v7.384c0 .63.692 1.01 1.233.697L11.5 8.753V12a.5.5 0 0 0 1 0V4z"/>
                    </svg>
                </button>
                <button id="shuffle-btn" class="control-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-shuffle" viewBox="0 0 16 16">
                      <path fill-rule="evenodd" d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3h.5a.5.5 0 0 1 0 1H13c-1.798 0-3.173 1.01-4.126 2.082A9.624 9.624 0 0 0 7.556 8a9.624 9.624 0 0 0 1.317 1.918C9.828 10.99 11.202 12 13 12h.5a.5.5 0 0 1 0 1H13c-2.202 0-3.827-1.24-4.874-2.418A10.595 10.595 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.624 9.624 0 0 0 6.444 8a9.624 9.624 0 0 0-1.317-1.918C4.172 5.01 2.798 4 1 4H.5a.5.5 0 0 1-.5-.5z"/>
                      <path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192zm0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192z"/>
                    </svg>
                </button>
            </div>
            <div class="flex items-center gap-2 w-full">
                <span id="current-time" class="text-white text-sm">0:00</span>
                <div id="progress-bar-container" class="w-full h-1 bg-gray-600 rounded-full cursor-pointer">
                    <div id="progress-bar" class="h-full bg-white rounded-full"></div>
                </div>
                <span id="duration" class="text-white text-sm">0:00</span>
            </div>
        </div>
        
        <div class="flex justify-end w-1/4">
            <input type="range" id="volumeSlider" min="0" max="10" value="10" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer custom-range">
            <span id="volumeValue" class="text-white text-sm ml-2">10</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const PLAYLIST_ID = 'PLM2V-zC1RStdE8dOpKnw25qUsSXz-YtTo'; // REPLACE WITH YOUR INVIDIOUS PLAYLIST ID

            // --- DOM Elements ---
            const playlistContainer = document.getElementById('playlistContainer');
            const audioPlayer = document.getElementById('audio-player-element');
            const currentSongImage = document.getElementById('current-song-image');
            const currentSongTitle = document.getElementById('current-song-title');
            const currentSongArtist = document.getElementById('current-song-artist');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const shuffleBtn = document.getElementById('shuffle-btn');
            const currentTimeSpan = document.getElementById('current-time');
            const durationSpan = document.getElementById('duration');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const progressBar = document.getElementById('progress-bar');
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeValueSpan = document.getElementById('volumeValue');
            const initialPlayButton = document.getElementById('initial-play-button');
            const controlsDiv = document.getElementById('controls');
            const playerContainer = document.getElementById('player-container');
            const visualizerElements = document.querySelectorAll('.visualizer-element');
            const playlistSidebar = document.getElementById('playlist-sidebar');

            // --- State Variables ---
            let currentPlaylist = [];
            let currentSongIndex = 0; // Start with the first song
            let isShuffle = false;
            let progressInterval;

            // --- Event Listeners ---
            playPauseBtn.addEventListener('click', togglePlayPause);
            nextBtn.addEventListener('click', playNextSong);
            prevBtn.addEventListener('click', playPreviousSong);
            shuffleBtn.addEventListener('click', toggleShuffle);
            volumeSlider.addEventListener('input', updateVolume);
            progressBarContainer.addEventListener('click', seekAudio);
            audioPlayer.addEventListener('timeupdate', updateProgressBar);
            audioPlayer.addEventListener('ended', playNextSong);
            initialPlayButton.addEventListener('click', handleInitialPlay);

            // --- Initialization ---
            loadPlaylist();

            // --- Functions ---
            async function loadPlaylist() {
                playlistContainer.innerHTML = 'Loading playlist...';
                try {
                    const response = await fetch(`/playlist-content?playlistId=${PLAYLIST_ID}`);
                    const data = await response.json();

                    if (data.length === 0) {
                        playlistContainer.innerHTML = '<p>No songs found in this playlist.</p>';
                        return;
                    }

                    currentPlaylist = data;
                    renderPlaylist();
                    // Load the first song's info for display, but don't autoplay yet
                    updateSongInfo(currentPlaylist[currentSongIndex]);
                    setBackground(currentPlaylist[currentSongIndex].thumbnail);

                } catch (error) {
                    console.error('Error loading playlist:', error);
                    playlistContainer.innerHTML = '<p>Error loading playlist. Please check the Playlist ID.</p>';
                }
            }

            function renderPlaylist() {
                playlistContainer.innerHTML = '';
                currentPlaylist.forEach((item, index) => {
                    const playlistItem = document.createElement('div');
                    playlistItem.classList.add('playlist-item');
                    if (index === currentSongIndex) {
                        playlistItem.classList.add('bg-blue-600');
                    }
                    playlistItem.innerHTML = `
                        <img src="${item.thumbnail}" alt="${item.title}" class="playlist-thumb">
                        <div class="playlist-info">
                            <span class="playlist-title">${item.title}</span>
                            <span class="playlist-channel">${item.author}</span>
                        </div>
                    `;
                    playlistItem.addEventListener('click', () => playSong(index));
                    playlistContainer.appendChild(playlistItem);
                });
            }

            async function playSong(index) {
                currentSongIndex = index;
                const song = currentPlaylist[currentSongIndex];

                updateSongInfo(song);
                setBackground(song.thumbnail);
                renderPlaylist(); // Re-render to highlight current song

                try {
                    const response = await fetch(`/play?videoId=${song.videoId}`);
                    const data = await response.json();

                    if (data.audioUrl) {
                        audioPlayer.src = data.audioUrl;
                        audioPlayer.play();
                        updatePlayPauseIcon(true);
                        startVisualizer();
                    } else {
                        console.error('No audio URL found:', data);
                        updatePlayPauseIcon(false);
                        stopVisualizer();
                    }
                } catch (error) {
                    console.error('Error playing song:', error);
                    updatePlayPauseIcon(false);
                    stopVisualizer();
                }
            }

            function updateSongInfo(song) {
                currentSongTitle.textContent = song.title;
                currentSongImage.src = song.thumbnail;
                currentSongImage.style.display = 'block';
                currentSongArtist.textContent = song.author;
            }

            function togglePlayPause() {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    updatePlayPauseIcon(true);
                    startVisualizer();
                } else {
                    audioPlayer.pause();
                    updatePlayPauseIcon(false);
                    stopVisualizer();
                }
            }

            function updatePlayPauseIcon(isPlaying) {
                if (isPlaying) {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                } else {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                }
            }

            function playNextSong() {
                if (currentPlaylist.length === 0) return;

                if (isShuffle) {
                    currentSongIndex = Math.floor(Math.random() * currentPlaylist.length);
                } else {
                    currentSongIndex = (currentSongIndex + 1) % currentPlaylist.length;
                }
                playSong(currentSongIndex);
            }

            function playPreviousSong() {
                if (currentPlaylist.length === 0) return;

                if (isShuffle) {
                    currentSongIndex = Math.floor(Math.random() * currentPlaylist.length);
                } else {
                    currentSongIndex = (currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
                }
                playSong(currentSongIndex);
            }

            function toggleShuffle() {
                isShuffle = !isShuffle;
                if (isShuffle) {
                    shuffleBtn.classList.add('bg-blue-600');
                } else {
                    shuffleBtn.classList.remove('bg-blue-600');
                }
            }

            function updateVolume() {
                const volume = volumeSlider.value / 10; // Scale 0-10 to 0-1
                audioPlayer.volume = volume;
                volumeValueSpan.textContent = volumeSlider.value;
            }

            function updateProgressBar() {
                const currentTime = audioPlayer.currentTime;
                const duration = audioPlayer.duration;

                currentTimeSpan.textContent = formatTime(currentTime);
                durationSpan.textContent = formatTime(duration);

                const progress = (currentTime / duration) * 100;
                progressBar.style.width = `${progress}%`;
            }

            function formatTime(time) {
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60).toString().padStart(2, '0');
                return `${minutes}:${seconds}`;
            }

            function seekAudio(e) {
                const rect = progressBarContainer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const width = rect.width;
                const duration = audioPlayer.duration;
                
                const seekTime = (clickX / width) * duration;
                audioPlayer.currentTime = seekTime;
            }

            function setBackground(imageUrl) {
                playerContainer.style.backgroundImage = `url('${imageUrl}')`;
                controlsDiv.style.backgroundImage = `url('${imageUrl}')`;
            }

            function handleInitialPlay() {
                if (currentPlaylist.length > 0) {
                    playSong(currentSongIndex); // Start playing the current song
                }

                initialPlayButton.classList.add('fade-out');
                controlsDiv.classList.remove('hidden');
                controlsDiv.classList.add('fade-in');
                playlistSidebar.classList.remove('hidden');

                initialPlayButton.addEventListener('animationend', () => {
                    initialPlayButton.style.display = 'none';
                });
            }

            function getRandomVibrantColor() {
                const hue = Math.floor(Math.random() * 360);
                const saturation = 90 + Math.random() * 10; // 90-100% saturation
                const lightness = 50 + Math.random() * 10; // 50-60% lightness
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            function startVisualizer() {
                visualizerElements.forEach((el, index) => {
                    el.classList.add('jumping');
                    el.style.animationDelay = `${index * 0.05}s`;
                    el.style.backgroundColor = getRandomVibrantColor();
                    el.style.boxShadow = `0 0 5px ${el.style.backgroundColor}, 0 0 10px ${el.style.backgroundColor}`;
                });
            }

            function stopVisualizer() {
                visualizerElements.forEach(el => {
                    el.classList.remove('jumping');
                    el.style.animationDelay = '';
                    el.style.backgroundColor = '';
                    el.style.boxShadow = '';
                });
            }
        });
    </script>
</body>
</html>
